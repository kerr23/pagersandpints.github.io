<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>I/O Spikes during Checkpoint :: Pagers and Pints — DevOps, SRE and Beer</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="I run Postgres on a fairly large linux server with 256G of ram.
During high load, I found that the I/O of the $PGDATA volume was spiking to 100% making the database slow down to a crawl for seconds at a time, despite having a fairly fast I/O subsystem.
This is what the spike looked like from an iostat output:
Date r/s w/s rsec/s wsec/s await svctm %util
[&amp;hellip;]
07/10/12 00:35:36 0 69."/>
<meta name="keywords" content="DevOps, SRE, Site Reliability, Pager"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="../../posts/i-o-spikes-during-checkpoint/" />


<link rel="stylesheet" href="../../assets/style.css">

  <link rel="stylesheet" href="../../assets/green.css">



<link rel="stylesheet" href="../../style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="../../img/favicon/green.png">



<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="I/O Spikes during Checkpoint :: Pagers and Pints — DevOps, SRE and Beer" />
<meta name="twitter:description" content="I run Postgres on a fairly large linux server with 256G of ram.
During high load, I found that the I/O of the $PGDATA volume was spiking to 100% making the database slow down to a crawl for seconds at a time, despite having a fairly fast I/O subsystem.
This is what the spike looked like from an iostat output:
Date r/s w/s rsec/s wsec/s await svctm %util
[&amp;hellip;]
07/10/12 00:35:36 0 69." />
<meta name="twitter:site" content="/" />
<meta name="twitter:creator" content="Dave Kerr" />
<meta name="twitter:image" content="">


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="I/O Spikes during Checkpoint :: Pagers and Pints — DevOps, SRE and Beer">
<meta property="og:description" content="I run Postgres on a fairly large linux server with 256G of ram.
During high load, I found that the I/O of the $PGDATA volume was spiking to 100% making the database slow down to a crawl for seconds at a time, despite having a fairly fast I/O subsystem.
This is what the spike looked like from an iostat output:
Date r/s w/s rsec/s wsec/s await svctm %util
[&amp;hellip;]
07/10/12 00:35:36 0 69." />
<meta property="og:url" content="/posts/i-o-spikes-during-checkpoint/" />
<meta property="og:site_name" content="I/O Spikes during Checkpoint" />
<meta property="og:image" content="">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2012-07-10 21:16:00 &#43;0000 UTC" />











</head>
<body class="">


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="../../">
  <div class="logo">
    Pagers and Pints
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="../../posts/i-o-spikes-during-checkpoint/">I/O Spikes during Checkpoint</a></h1>
  <div class="post-meta">
    <span class="post-date">
      2012-07-10
    </span>
    
    <span class="post-author">::
      Dave Kerr
    </span>
    
  </div>

  
  <span class="post-tags">
    
    #<a href="../../tags/postgresql/">postgresql</a>&nbsp;
    
  </span>
  

  

  <div class="post-content">
    <p>I run Postgres on a fairly large linux server with 256G of ram.</p>

<p>During high load, I found that the I/O of the $PGDATA volume was spiking to 100% making the database slow down to a crawl for seconds at a time, despite having a fairly fast I/O subsystem.</p>

<p>This is what the spike looked like from an iostat output:</p>

<p>Date                    r/s     w/s     rsec/s  wsec/s          await   svctm   %util<br />
[&hellip;]<br />
07/10/12 00:35:36       0       69.8    0       2233.6          0.63    0.07    0.46<br />
07/10/12 00:35:41       1.2     810     99.2    22200           4.13    0.05    4.02<br />
07/10/12 00:35:46       0       111.6   0       5422.4          1.82    0.08    0.9<br />
07/10/12 00:35:51       0       299.2   0       5670.4          1.27    0.04    1.24<br />
07/10/12 00:35:56       0.8     176.6   41.6    3654.4          2.16    0.07    1.32<br />
07/10/12 00:36:01       0       364.8   0       6670.4          1.1     0.04    1.62<br />
07/10/12 00:36:06       0.8     334.6   12.8    5953.6          1.18    0.05    1.64<br />
07/10/12 00:36:11       0       118.6   0       6948.8          1.82    0.07    0.82<br />
07/10/12 00:36:16       0       8274.6  0       148764.8        10.55   0.07    61.18<br />
07/10/12 00:36:21       0.2     8577.4  3.2     161806.4        16.68   0.12    99.62<br />
07/10/12 00:36:26       0.8     9244.6  12.8    167841.6        15.01   0.11    99.82<br />
07/10/12 00:36:31       0.8     9434.2  44.8    208156.8        16.22   0.11    99.7<br />
07/10/12 00:36:36       0       9582.8  0       202508.8        14.84   0.1     99.72<br />
07/10/12 00:36:41       0       9830.2  0       175326.4        14.42   0.1     99.5<br />
07/10/12 00:36:46       0       8208.6  0       149372.8        17.82   0.12    99.64<br />
07/10/12 00:36:51       3       1438.4  102.4   26748.8         8.49    0.12    18<br />
07/10/12 00:36:56       0.6     2004.6  9.6     27400           1.25    0.03    5.74<br />
07/10/12 00:37:01       0.6     1723    9.6     23758.4         1.85    0.03    5.08<br />
07/10/12 00:37:06       0.4     181.2   35.2    2928            1.49    0.06    1.06</p>

<p>The Linux I/O subsystem can get overwhelmed with dirty buffers when using a system with high memory + high volume.</p>

<p>If you consider that on a 256GB system - the defaults for RHEL 6.2:<br />
vm.dirty_ratio = 10 == 26Gb<br />
vm.dirty_background_ratio = 5 == 13Gb</p>

<p>You can see that you can have quite a bit of data to flush out when the fsync() is called as part of a checkpoint</p>

<p>To alleviate the problem there are 2 new kernel parameters:<br />
vm.dirty_bytes and vm.dirty_background_bytes</p>

<p>These settings allow you to specify a much smaller value for your filesystem buffer.</p>

<p>These settings take some tweaking to get right - you may consider the size of your RAID cache or your general I/O throughput.</p>

<p>In my case I found that the following settings worked well with my disk subsystem.<br />
vm.dirty_background_bytes = 33554432 # 32MB<br />
vm.dirty_bytes = 268435456 #256MB</p>

<p>You can see the difference in the following chart, the blue line is the default and the red line is with the new VM settings.</p>

<p>You can see that you&rsquo;re using slightly more I/O with the new settings but the spike doesn&rsquo;t end up happening.</p>

<p><a href="https://davidmkerr33786049.files.wordpress.com/2012/07/0daa6-pg.png"><img src="https://davidmkerr33786049.files.wordpress.com/2012/07/0daa6-pg.png?w=300" alt="" /></a></p>

<p>Thanks to Maxim, Jeff and Andres in <a href="http://archives.postgresql.org/pgsql-performance/2012-07/msg00105.php">this thread</a> for pointing me in te right direction And Greg who tried to explain it to me but I was too block headed at that time to get it.</p>

  </div>
  
  <div class="pagination">
    <div class="pagination__title">
      <span
        class="pagination__title-h">Read other posts</span>
      <hr />
    </div>
    <div class="pagination__buttons">
      
      <span class="button previous">
        <a href="../../posts/streaming-replication-syncing-mirrors-and-panic-wal-contains-references-to-invalid-pages/">
          <span class="button__icon">←</span>
          <span class="button__text">Streaming Replication, syncing mirrors and PANIC: WAL contains references to invalid pages</span>
        </a>
      </span>
      
      
      <span class="button next">
        <a href="../../posts/pg_service-conf-in-redhat/">
          <span class="button__text">pg_service.conf in redhat</span>
          <span class="button__icon">→</span>
        </a>
      </span>
      
    </div>
  </div>
  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2019 Powered by <a href="http://gohugo.io">Hugo</a></span>
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="../../assets/main.js"></script>
<script src="../../assets/prism.js"></script>





  
</div>

</body>
</html>
